<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Papan Peringkat - ExtraCourse</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #F9FAFB; /* bg-slate-50 */
        }
        .logo-image { height: 70px; width: auto; }
        .auth-button {
            padding: 0.5rem 1rem; border-radius: 0.375rem; font-weight: 500;
            transition: all 0.2s ease; display: inline-block; text-align: center;
        }
        .auth-button-primary { background-color: #2563EB; color: white; }
        .auth-button-primary:hover { background-color: #1D4ED8; }
        .auth-button-secondary { background-color: transparent; color: #2563EB; border: 1px solid #2563EB; }
        .auth-button-secondary:hover { background-color: #DBEAFE; color: #1D4ED8; }
        
        #userInfoDesktopTrigger { cursor: pointer; }
        #userPhotoDesktop { width: 32px; height: 32px; border-radius: 9999px; object-fit: cover; }
        .user-display-name {
            font-weight: 500; color: #374151; white-space: nowrap;
            overflow: hidden; text-overflow: ellipsis; max-width: 100px; 
        }
        #userDropdownMenuDesktop {
            display: none; position: absolute; right: 0; top: 100%; margin-top: 0.5rem; width: 14rem;
            background-color: white; border-radius: 0.375rem;
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05);
            z-index: 50; padding-top: 0.25rem; padding-bottom: 0.25rem; border: 1px solid #e5e7eb;
        }
        /* Style untuk Tabel Leaderboard */
        .table-container {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        .leaderboard-table {
            min-width: 100%;
            border-collapse: collapse;
        }
        .leaderboard-table th {
            padding: 0.75rem 1.5rem;
            text-align: left;
            font-size: 0.75rem;
            font-weight: 600;
            color: #4B5563; /* gray-600 */
            text-transform: uppercase;
            letter-spacing: 0.05em;
            background-color: #F3F4F6; /* gray-100 */
        }
        .leaderboard-table td {
            padding: 1rem 1.5rem;
            font-size: 0.875rem; /* text-sm */
            color: #374151; /* gray-700 */
            border-bottom: 1px solid #F3F4F6; /* gray-100 */
        }
        .rank-cell {
            font-weight: 700;
            font-size: 1.125rem; /* text-lg */
            color: #1F2937; /* gray-800 */
        }
        .user-cell {
            display: flex;
            align-items: center;
        }
        .user-cell img {
            width: 40px;
            height: 40px;
            border-radius: 9999px;
            margin-right: 1rem;
        }
        .xp-cell {
            font-weight: 700;
            color: #1D4ED8; /* blue-700 */
        }
    </style>
</head>
<body class="min-h-screen">

    <header class="bg-white shadow-md sticky top-0 z-40">
        <!-- Struktur Header lengkap disalin dari halaman lain -->
    </header>

    <main class="container mx-auto px-6 py-12 md:py-16">
        <h1 class="text-3xl md:text-4xl font-bold text-slate-800 mb-8">Papan Peringkat</h1>

        <div id="loadingState" class="text-center py-20">
            <p class="text-slate-500">Memuat papan peringkat...</p>
        </div>
        
        <div id="leaderboardContent" class="hidden bg-white rounded-xl shadow-lg overflow-hidden">
            <div class="table-container">
                <table class="leaderboard-table">
                    <thead>
                        <tr>
                            <th class="w-16">Peringkat</th>
                            <th>Pengguna</th>
                            <th class="text-center">Kuis Selesai</th>
                            <th class="text-center">Total XP</th>
                        </tr>
                    </thead>
                    <tbody id="leaderboard-body">
                        <!-- Peringkat akan di-render di sini oleh JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>

        <div id="errorState" class="hidden text-center py-20 bg-white p-8 rounded-xl shadow-md">
            <h2 class="text-2xl font-semibold text-red-700">Gagal Memuat Papan Peringkat</h2>
            <p class="text-slate-500 mt-2 mb-6">Terjadi kesalahan saat mengambil data. Jika ini pertama kali, mungkin perlu membuat Index di Firestore. Periksa console browser untuk link pembuatan index.</p>
            <a href="index.html" class="auth-button auth-button-secondary">Kembali ke Home</a>
        </div>

    </main>
    
    <footer class="bg-slate-800 text-slate-300 py-16 mt-16">
        <!-- Konten Footer Lengkap -->
    </footer>

    <script type="module">
        const firebaseConfig = { /* ...KONFIGURASI FIREBASE ANDA... */ };
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js";
        import { getFirestore, collection, query, orderBy, limit, getDocs, where } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js";

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        // --- Logika Header Universal (Salin dari file lain) ---
        // ... ...

        // --- Logika Halaman Ini ---
        const loadingStateDiv = document.getElementById('loadingState');
        const errorStateDiv = document.getElementById('errorState');
        const leaderboardContentDiv = document.getElementById('leaderboardContent');
        const leaderboardBody = document.getElementById('leaderboard-body');

        async function loadLeaderboard() {
            try {
                const usersRef = collection(db, "users");
                // Query untuk mendapatkan 10 pengguna teratas berdasarkan XP
                const q = query(usersRef, 
                    where("stats.xpPoints", ">", 0), // Filter pengguna dengan XP
                    orderBy("stats.xpPoints", "desc"), 
                    limit(10)
                );
                
                const querySnapshot = await getDocs(q);
                
                leaderboardBody.innerHTML = '';
                let rank = 1;

                querySnapshot.forEach((doc) => {
                    const userData = doc.data();
                    const stats = userData.stats || { quizzesCompleted: 0, xpPoints: 0 };
                    const photoURL = userData.photoURL || `https://ui-avatars.com/api/?name=${encodeURIComponent(userData.displayName)}&background=random&size=40&color=fff&font-size=0.5`;

                    const row = `
                        <tr>
                            <td class="rank-cell text-center">${rank}</td>
                            <td>
                                <div class="user-cell">
                                    <img src="${photoURL}" alt="Foto profil ${userData.displayName}">
                                    <span class="font-semibold">${userData.displayName}</span>
                                </div>
                            </td>
                            <td class="text-center">${stats.quizzesCompleted}</td>
                            <td class="text-center xp-cell">${stats.xpPoints} XP</td>
                        </tr>
                    `;
                    leaderboardBody.innerHTML += row;
                    rank++;
                });

                loadingStateDiv.style.display = 'none';
                leaderboardContentDiv.classList.remove('hidden');

            } catch (error) {
                console.error("Gagal memuat leaderboard:", error);
                // **PENTING**: Firebase akan memberikan link untuk membuat index di sini
                console.log("Jika ini pertama kali, error ini normal. Buka link di pesan error di atas untuk membuat index di Firestore, lalu refresh halaman ini setelah beberapa menit.");
                loadingStateDiv.style.display = 'none';
                errorStateDiv.classList.remove('hidden');
            }
        }
        
        onAuthStateChanged(auth, (user) => {
            // updateHeaderUI(user);
            if (user) {
                loadLeaderboard();
            } else {
                window.location.href = `login-page.html?redirect=${window.location.pathname}`;
            }
        });

    </script>
</body>
</html>
