<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Duel Kuis Sedang Berlangsung - ExtraCourse</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #111827; color: white; }
        .logo-image { height: 70px; width: auto; }
        
        .player-card {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 0.5rem;
        }
        .player-card.challenger { flex-direction: row; }
        .player-card.opponent { flex-direction: row-reverse; text-align: right; }
        .player-card img {
            width: 56px;
            height: 56px;
            border-radius: 9999px;
            border: 3px solid #374151;
        }
        .player-card .score {
            font-size: 1.875rem;
            font-weight: 800;
        }
        .vs-circle {
            width: 64px; height: 64px;
            background-color: #374151;
            border: 4px solid #4B5563;
            color: #D1D5DB;
            font-weight: 700;
            font-size: 1.5rem;
            display: flex; align-items: center; justify-content: center;
            border-radius: 9999px;
        }

        #quiz-container { max-width: 800px; margin: auto; }
        .progress-bar-bg { background-color: #374151; }
        .progress-bar-fill { background-color: #3B82F6; transition: width 0.3s ease-in-out; }
        .question-text { font-size: 1.5rem; font-weight: 600; color: #F9FAFB; margin-bottom: 2rem; }
        .option-btn {
            display: block; width: 100%; padding: 1rem; margin-bottom: 1rem;
            text-align: left; font-weight: 500; border: 2px solid #4B5563;
            border-radius: 0.5rem; transition: all 0.2s ease;
            background-color: #1F2937;
        }
        .option-btn:not(:disabled):hover { border-color: #3B82F6; background-color: #374151; }
        .option-btn.selected {
            border-color: #2563EB; background-color: #1E3A8A;
            color: white; box-shadow: 0 0 0 2px #3B82F6;
        }
        .option-btn.correct { border-color: #10B981; background-color: #059669; }
        .option-btn.wrong { border-color: #EF4444; background-color: #B91C1C; }
        .option-btn:disabled { cursor: not-allowed; opacity: 0.7; }
        
        .player-status-indicator {
            height: 12px; width: 12px; border-radius: 9999px;
            transition: background-color 0.3s;
        }
        .waiting-opponent-indicator { background-color: #6B7280; }
        .opponent-answered-indicator { background-color: #10B981; }
    </style>
</head>
<body class="min-h-screen">

    <header class="bg-gray-900 shadow-md sticky top-0 z-40">
        <div class="container mx-auto px-6 py-2">
            <div class="flex justify-between items-center">
                <div id="challenger-info" class="player-card challenger">
                    <img id="challenger-avatar" src="https://placehold.co/56x56/374151/FFFFFF?text=?">
                    <div>
                        <div class="flex items-center gap-2">
                             <div id="challenger-status" class="player-status-indicator waiting-opponent-indicator"></div>
                             <p id="challenger-name" class="font-bold"></p>
                        </div>
                        <p id="challenger-score" class="score">0</p>
                    </div>
                </div>
                <div class="vs-circle">VS</div>
                <div id="opponent-info" class="player-card opponent">
                    <img id="opponent-avatar" src="https://placehold.co/56x56/374151/FFFFFF?text=?">
                    <div>
                         <div class="flex items-center gap-2 justify-end">
                             <p id="opponent-name" class="font-bold"></p>
                             <div id="opponent-status" class="player-status-indicator waiting-opponent-indicator"></div>
                        </div>
                        <p id="opponent-score" class="score">0</p>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <main class="container mx-auto px-6 py-8 md:py-12">
        <div id="quiz-container" class="hidden"> 
            <div class="mb-8 text-center">
                <h1 id="quizTitle" class="text-xl md:text-2xl font-bold text-slate-300 mb-2"></h1>
                <p id="progressIndicator" class="text-slate-400"></p>
                <div class="w-full h-2 rounded-full progress-bar-bg mt-2 max-w-lg mx-auto">
                    <div id="progressBar" class="h-2 rounded-full progress-bar-fill" style="width: 0%;"></div>
                </div>
            </div>
            <div class="bg-gray-800 p-6 md:p-8 rounded-xl shadow-lg">
                <p id="questionText" class="question-text"></p>
                <div id="optionsContainer"></div>
                <div id="waiting-indicator" class="hidden text-center mt-6 text-amber-400">
                    Menunggu lawan menjawab...
                </div>
            </div>
        </div>
        <div id="loadingState" class="text-center py-20">
            <p class="text-slate-400">Menghubungkan ke ruang duel...</p>
        </div>
        <div id="errorState" class="hidden text-center py-20 bg-gray-800 p-8 rounded-xl shadow-md">
            <h2 id="errorTitle" class="text-2xl font-semibold text-red-500">Gagal Memuat Duel</h2>
            <p id="errorMessage" class="text-slate-400 mt-2 mb-6">Tidak dapat menemukan sesi duel yang valid.</p>
            <a href="index.html" class="inline-block px-6 py-2 text-sm font-medium text-white bg-blue-600 rounded-lg hover:bg-blue-700">Kembali ke Home</a>
        </div>
    </main>

    <script type="module">
        const firebaseConfig = { /* ...KONFIGURASI ANDA... */ };
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, collection, getDocs, updateDoc, increment, onSnapshot } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js";

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        let currentUser = null;
        let duelId = null;
        let unsubscribeDuel = null;
        let allQuestions = [];
        let currentQuizData = {};
        
        const loadingStateDiv = document.getElementById('loadingState');
        const errorStateDiv = document.getElementById('errorState');
        // ... (dan semua elemen DOM lainnya)

        function showError(title, message) { /* ... */ }
        function renderPlayerInfo(duelData, playersData) { /* ... */ }

        async function submitAnswer(answer) {
            const currentQuestionIndex = duelData.players[currentUser.uid].currentQuestion;
            const currentQuestion = allQuestions[currentQuestionIndex];
            const isCorrect = answer === currentQuestion.correctAnswer;
            
            const scoreUpdate = isCorrect ? increment(10) : 0;
            const playerPath = `players.${currentUser.uid}`;

            const duelDocRef = doc(db, "duels", duelId);
            await updateDoc(duelDocRef, {
                [`${playerPath}.answers.${currentQuestionIndex}`]: answer,
                [`${playerPath}.score`]: increment(scoreUpdate)
            });
        }

        function renderQuestion(duelData) {
            const myData = duelData.players[currentUser.uid];
            const opponentId = currentUser.uid === duelData.challengerId ? duelData.opponentId : duelData.challengerId;
            const opponentData = duelData.players[opponentId];

            const currentQuestionIndex = myData.currentQuestion;

            // Logika untuk menampilkan pertanyaan, opsi, dan status
            // ...

            if (myData.answers[currentQuestionIndex] && opponentData.answers[currentQuestionIndex]) {
                // Keduanya sudah menjawab, lanjut ke soal berikutnya setelah delay
                setTimeout(() => {
                    const nextQuestionIndex = currentQuestionIndex + 1;
                    if (nextQuestionIndex >= allQuestions.length) {
                        // Duel selesai
                        // ...
                    } else {
                        updateDoc(doc(db, "duels", duelId), {
                            [`players.${currentUser.uid}.currentQuestion`]: nextQuestionIndex,
                            [`players.${opponentId}.currentQuestion`]: nextQuestionIndex,
                        });
                    }
                }, 2000); // Delay 2 detik
            }
        }

        async function loadQuizData(kuisId) {
            // ... (Fungsi untuk mengambil data kuis dan pertanyaan)
        }

        async function handleDuelUpdate(duelDocSnap) {
            if (!duelDocSnap.exists()) {
                showError("Duel Dibatalkan", "Sesi duel ini telah dibatalkan atau tidak ada lagi.");
                if (unsubscribeDuel) unsubscribeDuel();
                return;
            }

            const duelData = duelDocSnap.data();

            if (allQuestions.length === 0) {
                await loadQuizData(duelData.quizId);
            }
            
            // Render UI berdasarkan data duel terbaru
            renderPlayerInfo(duelData);
            renderQuestion(duelData);
        }

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                const urlParams = new URLSearchParams(window.location.search);
                duelId = urlParams.get('duelId');
                if (!duelId) {
                    showError("ID Duel Hilang", "Tidak ada ID duel yang ditemukan di URL.");
                    return;
                }

                const duelDocRef = doc(db, "duels", duelId);
                unsubscribeDuel = onSnapshot(duelDocRef, handleDuelUpdate, (error) => {
                    console.error("Gagal mendengarkan update duel:", error);
                    showError("Koneksi Gagal", "Gagal terhubung ke sesi duel.");
                });
            } else {
                window.location.href = `login-page.html?redirect=${encodeURIComponent(window.location.href)}`;
            }
        });

    </script>
</body>
</html>
