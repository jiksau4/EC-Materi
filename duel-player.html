<script type="module">
    const firebaseConfig = {
        apiKey: "AIzaSyARLZcg_E2-H2UVD6qjc0Ls7m3Kkb-Uiyg",
        authDomain: "ec-materi.firebaseapp.com",
        projectId: "ec-materi",
        storageBucket: "ec-materi.firebasestorage.app",
        messagingSenderId: "166687187100",
        appId: "1:166687187100:web:e073df281931524f660d59"
    };

    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, collection, getDocs, updateDoc, increment, onSnapshot } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js";

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    let currentUser = null;
    let duelId = null;
    let unsubscribeDuel = null;
    let allQuestions = [];
    let currentQuizData = {};

    const loadingStateDiv = document.getElementById('loadingState');
    const errorStateDiv = document.getElementById('errorState');
    const errorTitleEl = document.getElementById('errorTitle');
    const errorMessageEl = document.getElementById('errorMessage');
    const quizContainer = document.getElementById('quiz-container');
    const quizTitleEl = document.getElementById('quizTitle');
    const progressIndicatorEl = document.getElementById('progressIndicator');
    const progressBarEl = document.getElementById('progressBar');
    const questionTextEl = document.getElementById('questionText');
    const optionsContainerEl = document.getElementById('optionsContainer');
    const waitingIndicator = document.getElementById('waiting-indicator');

    const challengerNameEl = document.getElementById('challenger-name');
    const challengerAvatarEl = document.getElementById('challenger-avatar');
    const challengerScoreEl = document.getElementById('challenger-score');
    const challengerStatusEl = document.getElementById('challenger-status');
    const opponentNameEl = document.getElementById('opponent-name');
    const opponentAvatarEl = document.getElementById('opponent-avatar');
    const opponentScoreEl = document.getElementById('opponent-score');
    const opponentStatusEl = document.getElementById('opponent-status');

    function showError(title, message) {
        loadingStateDiv.style.display = 'none';
        quizContainer.classList.add('hidden');
        errorTitleEl.textContent = title;
        errorMessageEl.textContent = message;
        errorStateDiv.classList.remove('hidden');
    }

    async function renderPlayerInfo(duelData) {
        const challengerId = duelData.challengerId;
        const opponentId = duelData.opponentId;
        const isCurrentUserChallenger = currentUser.uid === challengerId;
        const myId = currentUser.uid;
        const otherId = isCurrentUserChallenger ? opponentId : challengerId;

        challengerNameEl.textContent = isCurrentUserChallenger ? duelData.challengerName : duelData.opponentName;
        opponentNameEl.textContent = isCurrentUserChallenger ? duelData.opponentName : duelData.challengerName;

        challengerScoreEl.textContent = duelData.players[myId]?.score || 0;
        opponentScoreEl.textContent = duelData.players[otherId]?.score || 0;

        try {
            const myDoc = await getDoc(doc(db, "users", myId));
            const otherDoc = await getDoc(doc(db, "users", otherId));
            if (myDoc.exists()) challengerAvatarEl.src = myDoc.data().photoURL || `https://ui-avatars.com/api/?name=${encodeURIComponent(myDoc.data().displayName)}`;
            if (otherDoc.exists()) opponentAvatarEl.src = otherDoc.data().photoURL || `https://ui-avatars.com/api/?name=${encodeURIComponent(otherDoc.data().displayName)}`;
        } catch(e) {
            console.error("Gagal memuat foto profil pemain:", e);
        }
    }

    async function submitAnswer(answer) {
        const myData = currentQuizData.players[currentUser.uid];
        const currentQuestionIndex = myData.currentQuestion;
        const currentQuestion = allQuestions[currentQuestionIndex];
        const isCorrect = answer === currentQuestion.correctAnswer;

        const scoreUpdate = isCorrect ? 10 : 0; 
        const playerPath = `players.${currentUser.uid}`;

        const duelDocRef = doc(db, "duels", duelId);
        await updateDoc(duelDocRef, {
            [`${playerPath}.answers.${currentQuestionIndex}`]: answer,
            [`${playerPath}.score`]: increment(scoreUpdate)
        });
    }

    function renderQuestion(duelData) {
        if (allQuestions.length === 0) return;

        const myId = currentUser.uid;
        const isCurrentUserChallenger = duelData.challengerId === myId;
        const otherId = isCurrentUserChallenger ? duelData.opponentId : duelData.challengerId;

        const myData = duelData.players[myId];
        const opponentData = duelData.players[otherId];
        const currentQuestionIndex = myData.currentQuestion;

        if(currentQuestionIndex >= allQuestions.length) {
            if (unsubscribeDuel) unsubscribeDuel();
            showError("Duel Selesai!", "Halaman hasil duel akan segera dibuat.");
            return;
        }

        const question = allQuestions[currentQuestionIndex];
        progressIndicatorEl.textContent = `Pertanyaan ${currentQuestionIndex + 1} dari ${allQuestions.length}`;
        progressBarEl.style.width = `${((currentQuestionIndex + 1) / allQuestions.length) * 100}%`;
        questionTextEl.textContent = question.questionText;

        const myAnswer = myData.answers?.[currentQuestionIndex];
        const opponentAnswer = opponentData.answers?.[currentQuestionIndex];

        challengerScoreEl.textContent = duelData.players[myId]?.score || 0;
        opponentScoreEl.textContent = duelData.players[otherId]?.score || 0;

        if (myAnswer) {
            waitingIndicator.classList.add('hidden');
            optionsContainerEl.innerHTML = '';
            question.options.forEach(optionText => {
                const button = document.createElement('button');
                button.className = 'option-btn';
                button.textContent = optionText;
                button.disabled = true;
                if(optionText === myAnswer) button.classList.add('selected');
                optionsContainerEl.appendChild(button);
            });

            if(!opponentAnswer) {
                waitingIndicator.classList.remove('hidden');
            }
        } else {
            waitingIndicator.classList.add('hidden');
            optionsContainerEl.innerHTML = '';
            question.options.forEach(optionText => {
                const button = document.createElement('button');
                button.className = 'option-btn';
                button.textContent = optionText;
                button.onclick = () => submitAnswer(optionText);
                optionsContainerEl.appendChild(button);
            });
        }

        updatePlayerStatusIndicator(challengerStatusEl, isCurrentUserChallenger ? myData : opponentData, currentQuestionIndex);
        updatePlayerStatusIndicator(opponentStatusEl, isCurrentUserChallenger ? opponentData : myData, currentQuestionIndex);

        if (myAnswer && opponentAnswer) {
            waitingIndicator.classList.add('hidden');
            revealAnswers(question.correctAnswer);
            setTimeout(() => {
                if (isCurrentUserChallenger) {
                    const nextQuestionIndex = currentQuestionIndex + 1;
                    updateDoc(doc(db, "duels", duelId), {
                        [`players.${myId}.currentQuestion`]: nextQuestionIndex,
                        [`players.${otherId}.currentQuestion`]: nextQuestionIndex,
                    });
                }
            }, 2500);
        }
    }

    function updatePlayerStatusIndicator(statusEl, playerData, qIndex) {
        if (playerData.answers && playerData.answers[qIndex]) {
            statusEl.classList.remove('waiting-opponent-indicator');
            statusEl.classList.add('opponent-answered-indicator');
        } else {
            statusEl.classList.remove('opponent-answered-indicator');
            statusEl.classList.add('waiting-opponent-indicator');
        }
    }

    function revealAnswers(correctAnswer) {
        document.querySelectorAll('.option-btn').forEach(btn => {
            btn.disabled = true;
            if (btn.textContent === correctAnswer) {
                btn.classList.add('correct');
            } else if (btn.classList.contains('selected')) {
                btn.classList.add('wrong');
            }
        });
    }

    async function loadQuizData(kuisId) {
        const quizDocRef = doc(db, "quizzes", kuisId);
        const quizDocSnap = await getDoc(quizDocRef);
        if (!quizDocSnap.exists()) throw new Error("Dokumen kuis tidak ditemukan.");
        
        const quizData = quizDocSnap.data();
        const questionsColRef = collection(db, "quizzes", kuisId, "questions");
        const questionsSnapshot = await getDocs(questionsColRef);

        allQuestions = [];
        questionsSnapshot.forEach(doc => allQuestions.push(doc.data()));
        if (allQuestions.length === 0) throw new Error("Kuis ini tidak memiliki pertanyaan.");

        return quizData;
    }

    async function handleDuelUpdate(duelDocSnap) {
        if (!duelDocSnap.exists()) {
            showError("Duel Dibatalkan", "Sesi duel ini telah dibatalkan atau tidak ada lagi.");
            if (unsubscribeDuel) unsubscribeDuel();
            return;
        }

        currentQuizData = duelDocSnap.data();
        if (allQuestions.length === 0 && currentQuizData.quizId) {
            try {
                const quizInfo = await loadQuizData(currentQuizData.quizId);
                quizTitleEl.textContent = quizInfo.title;
                await renderPlayerInfo(currentQuizData);
                loadingStateDiv.style.display = 'none';
                quizContainer.classList.remove('hidden');
            } catch (error) {
                showError("Gagal Memuat Kuis", error.message);
                return;
            }
        }
        renderQuestion(currentQuizData);
    }

    onAuthStateChanged(auth, (user) => {
        if (user) {
            currentUser = user;
            const urlParams = new URLSearchParams(window.location.search);
            duelId = urlParams.get('duelId');
            if (!duelId) {
                showError("ID Duel Hilang", "Tidak ada ID duel yang ditemukan di URL.");
                return;
            }

            const duelDocRef = doc(db, "duels", duelId);
            unsubscribeDuel = onSnapshot(duelDocRef, handleDuelUpdate, (error) => {
                console.error("Gagal mendengarkan update duel:", error);
                showError("Koneksi Gagal", "Gagal terhubung ke sesi duel.");
            });
        } else {
            window.location.href = `login-page.html?redirect=${encodeURIComponent(window.location.href)}`;
        }
    });
</script>
